<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>가정 대형 폐기물 내림 서비스 계산기</title>
<style>
  :root { --bg:#f8fafc; --card:#fff; --border:#e5e7eb; --text:#111827; --muted:#6b7280; --primary:#111827; }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif; background:var(--bg); color:var(--text); }
  .container{ max-width:960px; margin:0 auto; padding:24px; }
  h1{ font-size:24px; font-weight:800; text-align:center; margin:0 0 8px; }
  p.lead{ text-align:center; color:var(--muted); font-size:13px; margin:0 0 24px; }
  .grid{ display:grid; grid-template-columns:1fr; gap:16px; }
  @media(min-width:900px){ .grid{ grid-template-columns:1fr 1fr; } }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.03); }
  .title{ font-weight:700; margin-bottom:12px; }
  .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; border-bottom:1px solid var(--border); padding:8px 0; }
  .row:last-child{ border-bottom:none; }
  .muted{ color:var(--muted); font-size:12px; }
  .input, .select{ width:140px; padding:8px 10px; border:1px solid var(--border); border-radius:10px; font-size:14px; }
  .btn{ border:1px solid var(--border); background:#fff; padding:8px 12px; border-radius:10px; font-size:13px; cursor:pointer; }
  .btn.primary{ background:var(--primary); color:#fff; border-color:var(--primary); }
  .chip{ border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer; background:#fff; }
  .chip.active{ background:#111827; color:#fff; border-color:#111827; }
  .grid-items{ display:grid; grid-template-columns:1fr; gap:8px; }
  @media(min-width:520px){ .grid-items{ grid-template-columns:1fr 1fr; } }
  .item{ display:flex; align-items:center; justify-content:space-between; gap:10px; border:1px solid var(--border); border-radius:12px; padding:10px 12px; }
  .pill{ background:#f3f4f6; border:1px solid var(--border); border-radius:12px; padding:12px; text-align:center; }
  .flex{ display:flex; gap:8px; flex-wrap:wrap; }
</style>
</head>
<body>
  <div class="container" id="app">
    <h1>가정 대형 폐기물 내림 서비스 계산기</h1>
    <p class="lead">지자체 대형폐기물 신고/스티커는 고객 실비 부담이며, 본 계산기는 수거·운반 서비스 요금 예시입니다.</p>

    <div class="grid">
      <section class="card">
        <div class="title">고객 입력</div>
        <div class="row">
          <div>
            <div>거리 (왕복 km)</div>
            <div class="muted">기본 <span id="cfgBaseKmLabel"></span>km 포함, 초과 km당 <span id="cfgPerKmLabel"></span>원</div>
          </div>
          <input class="input" type="number" id="distanceKm" value="8" />
        </div>

        <div class="row">
          <div>층수</div>
          <input class="input" type="number" id="floors" value="1" />
        </div>

        <div class="row">
          <div>엘리베이터</div>
          <div class="flex">
            <button class="chip active" id="elevYes">있음</button>
            <button class="chip" id="elevNo">없음</button>
          </div>
        </div>

        <div class="row">
          <div>보조 인력</div>
          <input class="input" type="number" id="helpers" value="0" />
        </div>

        <div class="row">
          <div>주말/야간</div>
          <div class="flex">
            <button class="chip" id="wkNo">미적용</button>
            <button class="chip active" id="wkYes">적용</button>
          </div>
        </div>

        <div style="margin:12px 0 6px; font-weight:600">품목 수량</div>
        <div class="grid-items" id="itemsList"></div>
      </section>

      <section class="card">
        <div class="title">예상 요금</div>
        <div class="row"><div class="muted">기본요금</div><div id="vBase">-</div></div>
        <div class="row"><div class="muted">품목 추가합</div><div id="vItems">-</div></div>
        <div class="row"><div class="muted">거리 추가</div><div id="vDist">-</div></div>
        <div class="row"><div class="muted">층수 추가(무엘리베이터)</div><div id="vFloor">-</div></div>
        <div class="row"><div class="muted">보조 인력</div><div id="vHelper">-</div></div>
        <div class="row"><div class="muted">주말/야간 가중치</div><div id="vMul">× 1.00</div></div>

        <div class="pill" style="margin:14px 0">
          <div class="muted">고객 결제 예상</div>
          <div style="font-weight:800; font-size:22px" id="vTotal">-</div>
        </div>

        <div class="flex">
          <button class="btn" id="btnCopy">견적 내용 복사</button>
          <button class="btn primary" id="btnPDF">PDF 견적서 다운로드</button>
          <button class="btn" id="btnShare">공유</button>
        </div>
        <div class="muted" style="margin-top:8px">※ 지자체 대형폐기물 스티커 비용은 별도(실비)입니다.</div>
      </section>
    </div>

    <details class="card" style="margin-top:18px" open>
      <summary class="title" style="cursor:pointer">운영자 설정</summary>
      <div class="grid" style="grid-template-columns:1fr 1fr 1fr">
        <label class="row"><span class="muted">상호/브랜드</span><input class="input" id="bizName" /></label>
        <label class="row"><span class="muted">연락처</span><input class="input" id="bizPhone" /></label>
        <label class="row"><span class="muted">이메일</span><input class="input" id="bizEmail" /></label>
        <label class="row"><span class="muted">기본요금</span><input class="input" type="number" id="cfgBaseFee" /></label>
        <label class="row"><span class="muted">기본거리(km)</span><input class="input" type="number" id="cfgBaseKm" /></label>
        <label class="row"><span class="muted">초과 km당</span><input class="input" type="number" id="cfgPerKm" /></label>
        <label class="row"><span class="muted">무엘베 층당</span><input class="input" type="number" id="cfgNoElev" /></label>
        <label class="row"><span class="muted">주말/야간 가산율(예:0.2)</span><input class="input" type="number" step="0.01" id="cfgWeekend" /></label>
        <label class="row"><span class="muted">보조 1인 비용</span><input class="input" type="number" id="cfgHelper" /></label>
      </div>

      <div style="margin-top:12px; font-weight:700">품목 단가</div>
      <div id="adminItems"></div>
      <div class="flex" style="margin-top:8px">
        <button class="btn" id="addItem">+ 품목 추가</button>
        <button class="btn" id="applyItems">단가 적용</button>
      </div>

      <div class="flex" style="margin-top:12px">
        <button class="btn" id="btnExport">설정 내보내기</button>
        <button class="btn" id="btnImport">설정 불러오기</button>
        <button class="btn" id="btnReset">기본값 복원</button>
      </div>
    </details>
  </div>

  <!-- jsPDF CDN -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    // ---------- Utilities ----------
    const KR = n => (Number(n)||0).toLocaleString('ko-KR');
    const $ = sel => document.querySelector(sel);
    const el = (tag, attrs={}, children=[]) => {
      const d = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v]) => {
        if(k==='class') d.className = v;
        else if(k==='text') d.textContent = v;
        else if(k==='value') d.value = v;
        else d.setAttribute(k,v);
      });
      children.forEach(c => d.appendChild(c));
      return d;
    };

    // ---------- Default Config ----------
    const DEF = {
      bizName: '',
      bizPhone: '',
      bizEmail: '',
      baseFee: 120000,
      baseDistanceKm: 10,
      extraPerKm: 1000,
      noElevPerFloor: 5000,
      weekendRate: 0.2,
      helperFee: 50000,
      items: [
        { id:'fridge', label:'냉장고(중/대)', price:20000, unitLabel:'대' },
        { id:'washer', label:'세탁기', price:15000, unitLabel:'대' },
        { id:'drum', label:'드럼 세탁기', price:20000, unitLabel:'대' },
        { id:'bed_s', label:'침대(싱글/더블)', price:10000, unitLabel:'세트' },
        { id:'bed_l', label:'침대(대형)', price:20000, unitLabel:'세트' },
        { id:'wardrobe', label:'장롱(2~3칸)', price:30000, unitLabel:'개' },
        { id:'desk', label:'책상/책장', price:10000, unitLabel:'개' },
        { id:'small', label:'소형가구', price:5000, unitLabel:'개' },
      ]
    };
    const LSKEY = 'haul_embed_cfg_v1';

    let CFG = loadCfg();
    let STATE = {
      distanceKm: 8,
      floors: 1,
      hasElevator: true,
      helpers: 0,
      weekend: true,
      items: Object.fromEntries((CFG.items||[]).map(i=>[i.id,0]))
    };

    function loadCfg(){
      try{ const raw = localStorage.getItem(LSKEY); if(raw){ return JSON.parse(raw); } }catch{}
      return JSON.parse(JSON.stringify(DEF));
    }
    function saveCfg(){ try{ localStorage.setItem(LSKEY, JSON.stringify(CFG)); }catch{} }

    // ---------- Calculator ----------
    function itemsSum(){
      return (CFG.items||[]).reduce((sum, i)=> sum + (Number(STATE.items[i.id]||0) * (Number(i.price)||0)), 0);
    }
    function calc(){
      const base = Number(CFG.baseFee)||0;
      const distExtra = Math.max(0, (Number(STATE.distanceKm)||0) - (Number(CFG.baseDistanceKm)||0)) * (Number(CFG.extraPerKm)||0);
      const floorExtra = STATE.hasElevator ? 0 : Math.max(0, Number(STATE.floors)||0) * (Number(CFG.noElevPerFloor)||0);
      const helperExtra = (Number(STATE.helpers)||0) * (Number(CFG.helperFee)||0);
      const subtotal = base + itemsSum() + distExtra + floorExtra + helperExtra;
      const weekendMul = STATE.weekend ? (1 + (Number(CFG.weekendRate)||0)) : 1;
      const total = Math.round(subtotal * weekendMul);

      $('#vBase').textContent   = KR(base) + '원';
      $('#vItems').textContent  = KR(itemsSum()) + '원';
      $('#vDist').textContent   = KR(distExtra) + '원';
      $('#vFloor').textContent  = KR(floorExtra) + '원';
      $('#vHelper').textContent = KR(helperExtra) + '원';
      $('#vMul').textContent    = '× ' + weekendMul.toFixed(2);
      $('#vTotal').textContent  = KR(total) + '원';
    }
    function refreshLabels(){
      $('#cfgBaseKmLabel').textContent = CFG.baseDistanceKm;
      $('#cfgPerKmLabel').textContent = KR(CFG.extraPerKm);
    }

    // ---------- Customer Items UI ----------
    function bindItems(){
      const wrap = $('#itemsList');
      wrap.innerHTML = '';
      (CFG.items||[]).forEach(it => {
        const qty = Number(STATE.items[it.id]||0);
        const row = el('div', { class:'item' }, [
          el('div', {}, [
            el('div', { text: it.label, class:'title', style:'font-weight:600; font-size:14px' }),
            el('div', { text: (it.unitLabel||'개') + '당 ' + KR(it.price) + '원', class:'muted' })
          ]),
          el('div', {}, [
            el('input', { class:'input', type:'number', value: qty, id: 'qty_'+it.id })
          ])
        ]);
        wrap.appendChild(row);
        row.querySelector('input').addEventListener('input', e=>{
          STATE.items[it.id] = Number(e.target.value||0);
          calc();
        });
      });
    }

    // ---------- Admin UI ----------
    function bindAdmin(){
      $('#bizName').value = CFG.bizName||'';
      $('#bizPhone').value = CFG.bizPhone||'';
      $('#bizEmail').value = CFG.bizEmail||'';
      $('#cfgBaseFee').value = CFG.baseFee;
      $('#cfgBaseKm').value = CFG.baseDistanceKm;
      $('#cfgPerKm').value = CFG.extraPerKm;
      $('#cfgNoElev').value = CFG.noElevPerFloor;
      $('#cfgWeekend').value = CFG.weekendRate;
      $('#cfgHelper').value = CFG.helperFee;
      refreshLabels();

      const adminWrap = $('#adminItems');
      adminWrap.innerHTML = '';
      (CFG.items||[]).forEach((it, idx)=>{
        const row = el('div', { class:'row' }, [
          el('input', { class:'input', value:it.label }),
          el('input', { class:'input', value:it.unitLabel||'개' }),
          el('input', { class:'input', type:'number', value:it.price }),
          el('button', { class:'btn', text:'삭제' })
        ]);
        // handlers
        const [iLabel, iUnit, iPrice, btnDel] = row.querySelectorAll('input,button');
        iLabel.addEventListener('input', e=> { CFG.items[idx].label = e.target.value; saveCfg(); bindItems(); });
        iUnit.addEventListener('input', e=> { CFG.items[idx].unitLabel = e.target.value; saveCfg(); bindItems(); });
        iPrice.addEventListener('input', e=> { CFG.items[idx].price = Number(e.target.value||0); saveCfg(); calc(); bindItems(); });
        btnDel.addEventListener('click', ()=>{ CFG.items.splice(idx,1); saveCfg(); bindAdmin(); bindItems(); calc(); });
        adminWrap.appendChild(row);
      });
    }

    // Admin: events
    $('#bizName').addEventListener('input', e=>{ CFG.bizName = e.target.value; saveCfg(); });
    $('#bizPhone').addEventListener('input', e=>{ CFG.bizPhone = e.target.value; saveCfg(); });
    $('#bizEmail').addEventListener('input', e=>{ CFG.bizEmail = e.target.value; saveCfg(); });
    $('#cfgBaseFee').addEventListener('input', e=>{ CFG.baseFee = Number(e.target.value||0); saveCfg(); calc(); });
    $('#cfgBaseKm').addEventListener('input', e=>{ CFG.baseDistanceKm = Number(e.target.value||0); saveCfg(); refreshLabels(); calc(); });
    $('#cfgPerKm').addEventListener('input', e=>{ CFG.extraPerKm = Number(e.target.value||0); saveCfg(); refreshLabels(); calc(); });
    $('#cfgNoElev').addEventListener('input', e=>{ CFG.noElevPerFloor = Number(e.target.value||0); saveCfg(); calc(); });
    $('#cfgWeekend').addEventListener('input', e=>{ CFG.weekendRate = Number(e.target.value||0); saveCfg(); calc(); });
    $('#cfgHelper').addEventListener('input', e=>{ CFG.helperFee = Number(e.target.value||0); saveCfg(); calc(); });
    $('#addItem').addEventListener('click', ()=>{
      const id = 'itm_' + Math.random().toString(36).slice(2,8);
      CFG.items.push({ id, label:'새 품목', price:0, unitLabel:'개' });
      saveCfg();
      // ensure customer state has the key
      STATE.items[id] = 0;
      bindAdmin(); bindItems(); calc();
    });
    $('#applyItems').addEventListener('click', ()=>{ saveCfg(); bindItems(); calc(); });
    $('#btnExport').addEventListener('click', async ()=> {
      const text = JSON.stringify(CFG, null, 2);
      try { await navigator.clipboard.writeText(text); alert('설정을 클립보드에 복사했습니다.'); }
      catch { alert(text); }
    });
    $('#btnImport').addEventListener('click', ()=> {
      const text = prompt('붙여넣기 할 설정 JSON을 입력하세요:');
      if(!text) return;
      try { CFG = JSON.parse(text); saveCfg(); bindAdmin(); bindItems(); calc(); }
      catch { alert('JSON 파싱 실패'); }
    });
    $('#btnReset').addEventListener('click', ()=> {
      CFG = JSON.parse(JSON.stringify(DEF));
      saveCfg(); bindAdmin(); bindItems(); calc();
    });

    // ---------- Customer inputs ----------
    $('#distanceKm').addEventListener('input', e=> { STATE.distanceKm = Number(e.target.value||0); calc(); });
    $('#floors').addEventListener('input', e=> { STATE.floors = Number(e.target.value||0); calc(); });
    $('#helpers').addEventListener('input', e=> { STATE.helpers = Number(e.target.value||0); calc(); });

    function setElev(has){
      STATE.hasElevator = has;
      $('#elevYes').classList.toggle('active', has);
      $('#elevNo').classList.toggle('active', !has);
      calc();
    }
    $('#elevYes').addEventListener('click', ()=> setElev(true));
    $('#elevNo').addEventListener('click', ()=> setElev(false));

    function setWeekend(on){
      STATE.weekend = on;
      $('#wkYes').classList.toggle('active', on);
      $('#wkNo').classList.toggle('active', !on);
      calc();
    }
    $('#wkYes').addEventListener('click', ()=> setWeekend(true));
    $('#wkNo').addEventListener('click', ()=> setWeekend(false));

    // ---------- Share/Copy/PDF ----------
    function buildQuoteText(){
      const date = new Date().toLocaleString();
      const itemsStr = (CFG.items||[])
        .map(i => `${i.label} ${STATE.items[i.id]||0}${i.unitLabel||'개'}`)
        .filter(s => !/ 0$/.test(s))
        .join('\\n');

      const base = Number(CFG.baseFee)||0;
      const distExtra = Math.max(0, (Number(STATE.distanceKm)||0) - (Number(CFG.baseDistanceKm)||0)) * (Number(CFG.extraPerKm)||0);
      const floorExtra = STATE.hasElevator ? 0 : Math.max(0, Number(STATE.floors)||0) * (Number(CFG.noElevPerFloor)||0);
      const helperExtra = (Number(STATE.helpers)||0) * (Number(CFG.helperFee)||0);
      const subtotal = base + itemsSum() + distExtra + floorExtra + helperExtra;
      const weekendMul = STATE.weekend ? (1 + (Number(CFG.weekendRate)||0)) : 1;
      const total = Math.round(subtotal * weekendMul);

      const lines = [
        `[가정 대형 폐기물 내림 서비스 견적]`,
        `일시: ${date}`,
        CFG.bizName ? `업체: ${CFG.bizName}` : null,
        CFG.bizPhone ? `연락처: ${CFG.bizPhone}` : null,
        CFG.bizEmail ? `이메일: ${CFG.bizEmail}` : null,
        ``,
        `거리(왕복): ${STATE.distanceKm}km`,
        `층수: ${STATE.floors}층 / 엘리베이터 ${STATE.hasElevator?'있음':'없음'}`,
        `보조 인력: ${STATE.helpers}명`,
        `주말/야간: ${STATE.weekend?'적용':'미적용'}`,
        ``,
        itemsStr ? `품목:\n${itemsStr}` : `품목: 없음`,
        ``,
        `예상 결제 금액: ${KR(total)}원`,
        `(대형폐기물 스티커 비용 별도)`
      ].filter(Boolean);
      return lines.join('\\n');
    }

    $('#btnCopy').addEventListener('click', async ()=> {
      const text = buildQuoteText();
      try { await navigator.clipboard.writeText(text); alert('견적 내용을 클립보드에 복사했습니다.'); }
      catch { alert(text); }
    });

    $('#btnShare').addEventListener('click', ()=> {
      const text = buildQuoteText();
      if (navigator.share) {
        navigator.share({ title:'가정 대형 폐기물 내림 서비스 견적', text });
      } else {
        alert('이 브라우저는 공유 기능을 지원하지 않습니다. 복사 기능을 이용하세요.');
      }
    });

    $('#btnPDF').addEventListener('click', ()=> {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const left = 14; let y = 20;
      doc.setFontSize(16); doc.text('가정 대형 폐기물 내림 서비스 견적서', left, y); y += 8;
      doc.setFontSize(11);
      const bizLine = [CFG.bizName, CFG.bizPhone, CFG.bizEmail].filter(Boolean).join('  •  ');
      if (bizLine) { doc.text(bizLine, left, y); y += 8; }
      doc.text(`작성일시: ${new Date().toLocaleString()}`, left, y); y += 10;

      const rows = [];
      rows.push(['거리(왕복)', `${STATE.distanceKm} km`]);
      rows.push(['층수/엘리베이터', `${STATE.floors}층 / ${STATE.hasElevator?'엘리베이터 있음':'없음'}`]);
      rows.push(['보조 인력', `${STATE.helpers} 명`]);
      rows.push(['주말/야간', STATE.weekend?'적용':'미적용' ]);
      rows.forEach(r=> { doc.text(`${r[0]}: ${r[1]}`, left, y); y += 7; });

      y += 3;
      doc.setFont(undefined, 'bold'); doc.text('품목', left, y); doc.setFont(undefined, 'normal'); y += 7;
      (CFG.items||[]).forEach(i=>{
        const qty = Number(STATE.items[i.id]||0);
        if(qty>0){ doc.text(`- ${i.label}: ${qty}${i.unitLabel||'개'}`, left, y); y += 6; }
      });

      const base = Number(CFG.baseFee)||0;
      const distExtra = Math.max(0, (Number(STATE.distanceKm)||0) - (Number(CFG.baseDistanceKm)||0)) * (Number(CFG.extraPerKm)||0);
      const floorExtra = STATE.hasElevator ? 0 : Math.max(0, Number(STATE.floors)||0) * (Number(CFG.noElevPerFloor)||0);
      const helperExtra = (Number(STATE.helpers)||0) * (Number(CFG.helperFee)||0);
      const subtotal = base + itemsSum() + distExtra + floorExtra + helperExtra;
      const weekendMul = STATE.weekend ? (1 + (Number(CFG.weekendRate)||0)) : 1;
      const total = Math.round(subtotal * weekendMul);

      y += 4;
      doc.setFont(undefined, 'bold'); doc.text(`예상 결제 금액: ${KR(total)}원`, left, y); doc.setFont(undefined, 'normal'); y += 8;
      doc.setFontSize(10); doc.text('※ 지자체 대형폐기물 스티커 비용은 별도(실비)입니다.', left, y);
      doc.save('견적서.pdf');
    });

    // ---------- Init ----------
    bindAdmin();
    bindItems();
    calc();

    // ---------- Dev Tests ----------
    (function runDevTests(){
      try{
        const t = buildQuoteText();
        console.assert(t.includes('예상 결제 금액'), '금액 출력 누락');
        // set one item and ensure it appears
        const id0 = CFG.items[0].id; STATE.items[id0] = 2;
        const t2 = buildQuoteText();
        console.assert(t2.includes('2'), '품목 수량 반영 안 됨');
      } catch(e){ console.warn('DevTests 실패:', e); }
    })();
  </script>
</body>
</html>
